<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume AI - Smart Resume Customization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        [x-cloak] { display: none !important; }
        .drag-over { border-color: #3b82f6; background-color: #eff6ff; }
        .nav-active { border-bottom-color: #3b82f6; color: #3b82f6; }
        .nav-inactive { border-bottom-color: transparent; color: #6b7280; }
        .toast {
            animation: slideInRight 0.5s ease-in-out, fadeOut 0.5s ease-in-out 4.5s forwards;
        }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; visibility: hidden; } }

        /* Enhanced Loading States */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Button States */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        .btn-success {
            background-color: #10b981 !important;
            transform: scale(1.05);
            transition: all 0.2s ease;
        }

        .btn-error {
            background-color: #ef4444 !important;
            transform: scale(0.95);
            transition: all 0.2s ease;
        }

        /* Progress Indicators */
        .progress-bar {
            transition: width 0.3s ease;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            transition: stroke-dasharray 0.3s ease;
        }

        /* Status Indicators */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-success { background-color: #10b981; }
        .status-warning { background-color: #f59e0b; }
        .status-error { background-color: #ef4444; }
        .status-info { background-color: #3b82f6; }
        .status-processing { background-color: #8b5cf6; }

        /* Enhanced Hover Effects */
        .hover-lift {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .hover-scale {
            transition: transform 0.2s ease;
        }
        .hover-scale:hover {
            transform: scale(1.05);
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        .placeholder-pill { cursor: grab; }
        .placeholder-pill:active { cursor: grabbing; }
        .placeholder-input { position: relative; }
        .placeholder-input.drag-over { border-color: #3b82f6; background-color: #eff6ff; }

    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans" x-data="resumeApp()" x-cloak>

    <div x-show="isLoading" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
    </div>
    <div class="fixed top-5 right-5 z-50 space-y-3 max-w-sm">
        <template x-for="toast in toasts" :key="toast.id">
            <div class="toast p-4 rounded-lg shadow-xl text-white transform transition-all duration-300 ease-in-out"
                 :class="{
                     'bg-red-500 border-l-4 border-red-600': toast.type === 'error',
                     'bg-green-500 border-l-4 border-green-600': toast.type === 'success',
                     'bg-blue-500 border-l-4 border-blue-600': toast.type === 'info',
                     'bg-yellow-500 border-l-4 border-yellow-600': toast.type === 'warning'
                 }"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform translate-x-full"
                 x-transition:enter-end="opacity-100 transform translate-x-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform translate-x-0"
                 x-transition:leave-end="opacity-0 transform translate-x-full">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <template x-if="toast.type === 'success'">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                        </template>
                        <template x-if="toast.type === 'error'">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                            </svg>
                        </template>
                        <template x-if="toast.type === 'info'">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                        </template>
                        <template x-if="toast.type === 'warning'">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                        </template>
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm font-medium" x-text="toast.message"></p>
                    </div>
                    <div class="ml-4 flex-shrink-0">
                        <button @click="closeToast(toast.id)" class="inline-flex text-white hover:text-gray-200">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>
    <div x-show="showDeleteModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-40 fade-in">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <h2 class="text-2xl font-semibold mb-4" x-text="deleteContext === 'resume' ? 'Delete Resume' : (deleteContext === 'application' ? 'Delete Application' : 'Delete Scraped JD')"></h2>
            <p class="text-gray-600 mb-6">Are you sure? This action cannot be undone.</p>
            <div class="mt-8 flex justify-end space-x-4">
                <button @click="showDeleteModal = false" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
                <button @click="deleteItem()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>
    <div x-show="showResumeSelectionModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-40 fade-in">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-lg w-full">
            <h2 class="text-2xl font-semibold mb-4">Select a Resume to Use</h2>
            <p class="text-gray-600 mb-6">Which resume would you like to customize for the role at <strong x-text="jdToUse?.company_name"></strong>?</p>
            <div class="space-y-3 max-h-60 overflow-y-auto">
                <template x-for="resume in resumes" :key="resume.id">
                    <button @click="startCustomizationWithSelectedResume(resume)" class="w-full text-left p-3 border rounded-lg hover:bg-gray-100 hover:border-blue-500">
                        <span class="font-semibold text-gray-800" x-text="resume.resume_name"></span>
                    </button>
                </template>
            </div>
            <div class="mt-8 flex justify-end">
                <button @click="showResumeSelectionModal = false" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
            </div>
        </div>
    </div>

    <div x-show="showSettingsModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-40 fade-in">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-4xl w-full h-[90vh] flex flex-col">
            <div class="flex justify-between items-center border-b pb-4 mb-4">
                <h2 class="text-2xl font-semibold">Customize AI Prompts</h2>
                <button @click="showSettingsModal = false" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            
            <div class="flex-grow flex flex-col overflow-hidden">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button @click="activeSettingsTab = 'paragraphs'" :class="activeSettingsTab === 'paragraphs' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Paragraphs</button>
                        <button @click="activeSettingsTab = 'cover_letter'" :class="activeSettingsTab === 'cover_letter' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Cover Letter</button>
                        <button @click="activeSettingsTab = 'interview_prep'" :class="activeSettingsTab === 'interview_prep' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Interview Prep</button>
                    </nav>
                </div>
                
                <div class="flex-grow mt-4 overflow-y-auto pr-2">
                    <template x-for="(promptData, key) in customPrompts" :key="key">
                        <div x-show="activeSettingsTab === key">
                            <h3 class="text-lg font-medium text-gray-700 mb-2">Available Placeholders</h3>
                            <p class="text-xs text-gray-500 mb-3">Drag these placeholders and drop them into the text area below.</p>
                            <div class="flex flex-wrap gap-2 mb-4 p-3 bg-gray-50 rounded-lg border">
                                <template x-for="placeholder in promptPlaceholders[key]" :key="placeholder">
                                    <span class="placeholder-pill bg-blue-100 text-blue-800 text-xs font-mono px-2 py-1 rounded" draggable="true" x-text="placeholder" @dragstart="handleDragStart(event, placeholder)"></span>
                                </template>
                            </div>
                            <textarea x-ref="`${key}Textarea`" x-model="customPrompts[key]" rows="18" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 font-mono text-sm placeholder-input" :data-textarea-key="key" @drop="handleDrop(event, key)" @dragover="handleDragOver(event, key)" @dragleave="handleDragLeave(event, key)" @input="highlightPlaceholders(key)" contenteditable="true" spellcheck="false"></textarea>
                        </div>
                    </template>
                </div>
            </div>

            <div class="mt-6 flex justify-between items-center pt-4 border-t">
                 <button @click="resetPrompts()" class="text-sm text-gray-600 hover:text-red-600">Reset All to Defaults</button>
                <div class="flex space-x-4">
                    <button @click="showSettingsModal = false" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
                    <button @click="savePrompts()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Save Prompts</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-6">
            <h1 class="text-5xl font-bold text-gray-800 mb-2">Resume AI</h1>
            <p class="text-gray-600 text-lg">Your Personal Resume & Application Hub</p>
            <div x-show="userSessionId" class="mt-2">
                <p class="text-xs text-gray-500">Your Session ID (for extension): <span @click="copyToClipboard(userSessionId)" class="font-mono bg-gray-200 p-1 rounded cursor-pointer" title="Click to copy" x-text="userSessionId"></span></p>
            </div>
        </div>

        <div class="mb-8 bg-white rounded-lg shadow-sm p-2 max-w-xl mx-auto" x-show="view !== 'nameEntry' && view !== 'paragraphSelection'">
             <nav class="flex justify-center space-x-2 sm:space-x-4">
                <button @click="navigateTo('dashboard')" class="px-3 py-2 text-sm font-medium border-b-2 transition" :class="mainView === 'dashboard' ? 'nav-active' : 'nav-inactive'">My Resumes</button>
                <button @click="navigateTo('scrapedJDs')" class="px-3 py-2 text-sm font-medium border-b-2 transition" :class="mainView === 'scrapedJDs' ? 'nav-active' : 'nav-inactive'">Scraped JDs</button>
                <button @click="navigateTo('resultsHub')" class="px-3 py-2 text-sm font-medium border-b-2 transition" :class="mainView === 'resultsHub' ? 'nav-active' : 'nav-inactive'">AI Results Hub</button>
                <button @click="navigateTo('applications')" class="px-3 py-2 text-sm font-medium border-b-2 transition" :class="mainView === 'applications' ? 'nav-active' : 'nav-inactive'">My Applications</button>
                <button @click="showSettingsModal = true" title="Settings" class="p-2 text-gray-500 hover:text-blue-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                </button>
             </nav>
        </div>

        <div x-show="view !== 'nameEntry' && view !== 'paragraphSelection'">

            <div x-show="mainView === 'dashboard' && view === 'dashboard'" class="fade-in space-y-10">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Upload a New Resume</h2>
                    <div class="grid md:grid-cols-2 gap-6 items-center">
                        <div class="space-y-4">
                            <input type="text" x-model="newResumeName" placeholder="e.g., My Main Tech Resume" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                            <button @click="triggerFileUpload()" :disabled="!newResumeName.trim()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:opacity-50 font-semibold">Select .DOCX File & Upload</button>
                        </div>
                        <div @dragover.prevent="isDragging = true" @dragleave.prevent="isDragging = false" @drop.prevent="handleFileDrop($event)" class="border-2 border-dashed rounded-lg p-8 text-center h-full flex flex-col justify-center" :class="{ 'drag-over': isDragging }">
                            <input type="file" id="resumeFileInput" @change="handleFileSelect($event)" class="hidden" accept=".docx">
                            <p class="text-gray-500">...or drag and drop file here.</p>
                            <p x-show="fileToUpload" class="mt-2 text-sm font-medium text-green-600" x-text="fileToUpload ? fileToUpload.name : ''"></p>
                        </div>
                    </div>
                </div>
                <div>
                    <h2 class="text-2xl font-semibold mb-4">Your Resumes</h2>
                    <div x-show="resumes.length === 0" class="text-center bg-white rounded-lg shadow p-8"><p class="text-gray-500">No resumes uploaded yet.</p></div>
                    <div x-show="resumes.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <template x-for="resume in resumes" :key="resume.id">
                            <div class="bg-white rounded-lg shadow-md p-5 flex flex-col justify-between hover-lift hover:shadow-xl transition-all duration-200">
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800" x-text="resume.resume_name"></h3>
                                    <p class="text-xs text-gray-500 mb-4" x-text="'Uploaded: ' + new Date(resume.created_date).toLocaleDateString()"></p>
                                </div>
                                <div class="flex flex-col space-y-2 mt-4">
                                    <button @click="startCustomization(resume)" class="w-full bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 hover-scale text-sm font-semibold transition-all duration-200">🚀 Use this Resume</button>
                                    <button @click="editSelections(resume.id)" class="w-full bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 hover-scale text-sm transition-all duration-200">✏️ Edit Selections</button>
                                    <button @click="confirmDelete(resume.id, 'resume')" class="w-full bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 hover-scale text-sm transition-all duration-200">🗑️ Delete</button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <div x-show="mainView === 'scrapedJDs'" class="fade-in bg-white rounded-lg shadow-lg p-6">
                 <h2 class="text-2xl font-semibold mb-4">Scraped Job Descriptions</h2>
                 <p class="text-gray-600 mb-6 text-sm">Use the browser extension on a job posting page to send jobs here.</p>
                 <div x-show="scrapedJDs.length === 0" class="text-center p-8"><p class="text-gray-500">No job descriptions have been scraped yet.</p></div>
                 <div x-show="scrapedJDs.length > 0" class="space-y-4">
                    <template x-for="jd in scrapedJDs" :key="jd.id">
                         <div class="border rounded-lg p-4 flex justify-between items-center hover:bg-gray-50" :class="jd.status === 'generated' ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200'">
                            <div>
                                <div class="flex items-center space-x-2">
                                    <h3 class="font-bold text-lg text-blue-600" x-text="jd.job_title"></h3>
                                    <span x-show="jd.status === 'generated'" class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-medium">Generated</span>
                                </div>
                                <p class="text-md text-gray-700 font-semibold" x-text="jd.company_name"></p>
                                <p class="text-xs text-gray-500 mt-1">
                                    Scraped: <span x-text="new Date(jd.created_date).toLocaleString()"></span> |
                                    <a :href="jd.page_url" target="_blank" class="text-blue-500 hover:underline">Source</a>
                                </p>
                            </div>
                            <div class="flex space-x-2 flex-shrink-0 ml-4">
                                <button
                                    @click="useScrapedJD(jd)"
                                    :class="jd.status === 'generated' ? 'bg-blue-500 hover:bg-blue-600' : 'bg-green-500 hover:bg-green-600'"
                                    class="text-white px-4 py-2 rounded-md text-sm font-semibold"
                                >
                                    <span x-show="jd.status === 'generated'">🔄 Re-generate</span>
                                    <span x-show="jd.status !== 'generated'">✨ Customize</span>
                                </button>
                                <button @click="confirmDelete(jd.id, 'scraped_jd')" class="bg-red-500 text-white px-3 py-2 rounded-md hover:bg-red-600 text-sm">🗑️</button>
                            </div>
                         </div>
                    </template>
                 </div>
            </div>

             <div x-show="mainView === 'resultsHub'" class="fade-in bg-white rounded-lg shadow-lg p-6">
                 <h2 class="text-2xl font-semibold mb-4">AI Results Hub</h2>
                 <div x-show="completedJobs.length === 0 && activeJobs.length === 0" class="text-center p-8"><p class="text-gray-500">No AI jobs run yet. Customize a resume to see results here.</p></div>
                 <div x-show="completedJobs.length > 0 || activeJobs.length > 0" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Company</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="job in activeJobs.filter(j => j.type !== 'interview_prep')" :key="job.id">
                                 <tr class="bg-blue-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="job.company_name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <div class="flex items-center space-x-2 text-gray-500">
                                            <div class="animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-blue-500"></div>
                                            <span>Processing...</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="new Date().toLocaleDateString()"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"></td>
                                 </tr>
                            </template>
                            <template x-for="job in completedJobs" :key="job.id">
                                <tr class="hover:bg-gray-50">
                                    <td @click="viewResults(job.id)" class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600 hover:text-blue-800 cursor-pointer" x-text="job.company_name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">Ready to View</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="new Date(job.timestamp).toLocaleDateString()"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button @click="deleteResult(job.id)" class="text-red-600 hover:text-red-900">Discard</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                 </div>
            </div>

            <div x-show="mainView === 'applications'" class="fade-in bg-white rounded-lg shadow-lg p-6">
                 <h2 class="text-2xl font-semibold mb-4">My Applications</h2>
                 <div x-show="applications.length === 0" class="text-center p-8"><p class="text-gray-500">No applications saved yet.</p></div>
                 <div x-show="applications.length > 0" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Company</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Match</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Job Link</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date Saved</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="app in applications" :key="app.id">
                                <tr class="hover:bg-gray-50">
                                    <td @click="viewApplicationDetails(app.id)" class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600 hover:text-blue-800 cursor-pointer" x-text="app.company_name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="app.match_score ? app.match_score + '%' : 'N/A'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <select @change="updateApplication(app.id, { status: $event.target.value })" :value="app.status" class="rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 text-xs">
                                            <option value="not_applied">Not Applied</option>
                                            <option value="applied">Applied</option>
                                            <option value="interview">Interview</option>
                                            <option value="offer">Offer</option>
                                            <option value="rejected">Rejected</option>
                                        </select>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <div x-show="app.job_posting_url" class="flex items-center space-x-2">
                                            <a :href="app.job_posting_url" target="_blank" class="text-blue-500 hover:text-blue-700 flex items-center">
                                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                                </svg>
                                                <span class="text-xs">Original Job</span>
                                            </a>
                                        </div>
                                        <span x-show="!app.job_posting_url" class="text-gray-400 text-xs">Manual entry</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="new Date(app.created_date).toLocaleDateString()"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button @click="confirmDelete(app.id, 'application')" class="text-red-600 hover:text-red-900">Delete</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                 </div>
            </div>
        </div>

        <div x-show="view === 'results'" class="fade-in">
             <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="border-b pb-4 mb-6">
                    <h2 class="text-3xl font-bold mb-1">AI Customization Results</h2>
                    <p class="text-gray-600">Review and finalize the results for your application to <strong x-text="activeResult.company_name"></strong>.</p>
                </div>
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="flex flex-col">
                        <h3 class="text-xl font-semibold mb-4">Enhanced Paragraphs</h3>
                        <div class="space-y-4 flex-grow overflow-y-auto pr-4 border rounded-lg p-4 bg-gray-50 min-h-[50vh]">
                             <template x-for="(enhanced, original) in activeResult.customized_paragraphs" :key="original">
                                <div class="border-b pb-4">
                                   <div class="flex justify-between items-start">
                                        <div>
                                           <p class="text-xs text-gray-500 mb-1">Original:</p>
                                           <p class="text-sm text-gray-600 italic mb-2" x-text="original"></p>
                                           <p class="text-xs text-green-600 mb-1">Enhanced:</p>
                                           <p class="text-sm text-gray-800" x-text="enhanced"></p>
                                        </div>
                                        <button @click="runCustomization({ result_id: activeResult.id, regenerate: { 'single_paragraph': original } })" title="Regenerate this paragraph" class="ml-4 p-1 text-gray-500 hover:text-blue-600 flex-shrink-0">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                             <h3 class="text-xl font-semibold">Generated Cover Letter</h3>
                             <button @click="copyToClipboard(activeResult.cover_letter)" title="Copy to clipboard" class="p-1 text-gray-400 hover:text-gray-700">
                                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" />
                                </svg>
                             </button>
                        </div>
                        <div class="border rounded-lg p-4 bg-gray-50 flex-grow overflow-y-auto min-h-[50vh]">
                            <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="activeResult.cover_letter"></p>
                        </div>
                        <div class="mt-6" x-show="activeResult.match_score">
                            <h3 class="text-lg font-medium mb-3">🎯 Job Match Analysis</h3>
                            <div class="bg-gray-50 rounded-lg p-4 border">
                                <div class="flex items-center space-x-4 mb-3">
                                    <div class="text-4xl font-bold" :class="activeResult.match_score >= 80 ? 'text-green-500' : 'text-yellow-500'" x-text="activeResult.match_score + '%'"></div>
                                    <div class="w-full bg-gray-200 rounded-full h-4">
                                        <div class="h-4 rounded-full" :class="activeResult.match_score >= 80 ? 'bg-green-500' : 'bg-yellow-500'" :style="`width: ${activeResult.match_score}%`"></div>
                                    </div>
                                </div>
                                <div x-show="activeResult.match_score_analysis" class="text-sm text-gray-600 italic border-t pt-3">
                                    <p x-text="activeResult.match_score_analysis"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-4 my-6">
                    <button @click="runCustomization({ result_id: activeResult.id, regenerate: 'paragraphs' })" class="text-sm bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">🔄 Regenerate All Paragraphs</button>
                    <button @click="runCustomization({ result_id: activeResult.id, regenerate: 'cover_letter' })" class="text-sm bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">🔄 Regenerate Cover Letter</button>
                </div>

                <div class="mt-8 pt-6 border-t flex flex-wrap gap-4 justify-between items-center">
                    <button @click="navigateTo('resultsHub')" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">Back to Results Hub</button>
                    <div class="flex space-x-4">
                         <button @click="downloadCustomizedResume(activeResult)" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-semibold">📄 Download Resume</button>
                         <button @click="saveCurrentApplication()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-semibold">💾 Save to My Applications</button>
                    </div>
                </div>
             </div>
        </div>

        <div x-show="view === 'applicationDetail'" class="fade-in">
             <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="border-b pb-4 mb-6 flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold mb-1" x-text="activeApplication.company_name"></h2>
                        <p class="text-gray-600">Reviewing saved application. Resume used: <strong x-text="activeApplication.resume_name"></strong></p>
                    </div>
                    <button @click="navigateTo('applications')" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">Back to Applications</button>
                </div>
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="flex flex-col">
                        <h3 class="text-xl font-semibold mb-4">Job Description</h3>
                        <div class="space-y-4 flex-grow overflow-y-auto pr-4 border rounded-lg p-4 bg-gray-50 min-h-[50vh]">
                            <p class="whitespace-pre-wrap" x-text="activeApplication.job_description"></p>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                             <h3 class="text-xl font-semibold">Saved Cover Letter</h3>
                              <button @click="copyToClipboard(activeApplication.cover_letter)" title="Copy to clipboard" class="p-1 text-gray-400 hover:text-gray-700">
                                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" />
                                </svg>
                             </button>
                        </div>
                        <div class="border rounded-lg p-4 bg-gray-50 flex-grow overflow-y-auto min-h-[50vh]">
                            <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="activeApplication.cover_letter"></p>
                        </div>
                        <div class="mt-6" x-show="activeApplication.match_score">
                            <h3 class="text-lg font-medium mb-3">🎯 Job Match Analysis</h3>
                            <div class="bg-gray-50 rounded-lg p-4 border">
                                <div class="flex items-center space-x-4 mb-3">
                                    <div class="text-4xl font-bold" :class="activeApplication.match_score >= 80 ? 'text-green-500' : 'text-yellow-500'" x-text="activeApplication.match_score + '%'"></div>
                                    <div class="w-full bg-gray-200 rounded-full h-4">
                                        <div class="h-4 rounded-full" :class="activeApplication.match_score >= 80 ? 'bg-green-500' : 'bg-yellow-500'" :style="`width: ${activeApplication.match_score}%`"></div>
                                    </div>
                                </div>
                                <div x-show="activeApplication.match_score_analysis" class="text-sm text-gray-600 italic border-t pt-3">
                                    <p x-text="activeApplication.match_score_analysis"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Interview Preparation</h3>
                        <div x-show="activeApplication.interview_prep" class="flex items-center space-x-3">
                             <button @click="copyInterviewPrompt(activeApplication.id)" class="text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded-md hover:bg-gray-300">📋 Copy Prompt</button>
                             <button @click="generateInterviewPrep(activeApplication.id)" class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-md hover:bg-blue-200">🔄 Regenerate</button>
                        </div>
                    </div>

                    <div x-show="isJobActive('interview_prep', activeApplication.id)" class="bg-blue-50 p-6 rounded-lg text-center">
                        <div class="flex items-center justify-center space-x-3">
                            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
                            <p class="text-blue-700">Generating questions... this may take a moment.</p>
                        </div>
                    </div>

                    <div x-show="!activeApplication.interview_prep && !isJobActive('interview_prep', activeApplication.id)" class="bg-gray-100 p-6 rounded-lg text-center">
                        <p class="text-gray-600 mb-4">Generate AI-powered, personalized interview questions based on your resume and the job description.</p>
                        <button @click="generateInterviewPrep(activeApplication.id)" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-semibold">✨ Generate Questions</button>
                    </div>

                    <div x-show="activeApplication.interview_prep" class="space-y-8">
                        <template x-if="activeApplication.interview_prep">
                            <div>
                                <template x-if="activeApplication.interview_prep.general_questions && activeApplication.interview_prep.general_questions.length > 0">
                                    <div class="mb-6">
                                        <h4 class="text-lg font-semibold mb-3 text-gray-800 border-b pb-2">General Questions</h4>
                                        <div class="space-y-3">
                                            <template x-for="(q, index) in activeApplication.interview_prep.general_questions" :key="'gen-' + index">
                                                <div class="border rounded-lg p-4 bg-white">
                                                    <div @click="q.showAnswer = !q.showAnswer" class="flex justify-between items-center cursor-pointer">
                                                        <p class="font-medium text-gray-800" x-text="q.question"></p>
                                                        <span class="text-blue-500" x-text="q.showAnswer ? '−' : '+'" ></span>
                                                    </div>
                                                    <div x-show="q.showAnswer" x-collapse.duration.300ms class="mt-3 pt-3 border-t">
                                                        <h5 class="text-sm font-semibold text-gray-600">Talking Points:</h5>
                                                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1 my-2 pl-2">
                                                            <template x-for="point in q.talking_points" :key="point">
                                                                <li x-text="point"></li>
                                                            </template>
                                                        </ul>
                                                        <h5 class="text-sm font-semibold text-gray-600 mt-3">Sample Answer:</h5>
                                                        <p class="text-sm text-gray-700 mt-1 bg-gray-50 p-3 rounded" x-text="q.answer"></p>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="activeApplication.interview_prep.role_based_questions && activeApplication.interview_prep.role_based_questions.length > 0">
                                    <div class="mb-6">
                                        <h4 class="text-lg font-semibold mb-3 text-gray-800 border-b pb-2">Role-Based Questions</h4>
                                        <div class="space-y-3">
                                            <template x-for="(q, index) in activeApplication.interview_prep.role_based_questions" :key="'role-' + index">
                                                <div class="border rounded-lg p-4 bg-white">
                                                    <div @click="q.showAnswer = !q.showAnswer" class="flex justify-between items-center cursor-pointer">
                                                        <p class="font-medium text-gray-800" x-text="q.question"></p>
                                                        <span class="text-blue-500" x-text="q.showAnswer ? '−' : '+'" ></span>
                                                    </div>
                                                    <div x-show="q.showAnswer" x-collapse.duration.300ms class="mt-3 pt-3 border-t">
                                                        <h5 class="text-sm font-semibold text-gray-600">Talking Points:</h5>
                                                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1 my-2 pl-2">
                                                            <template x-for="point in q.talking_points" :key="point">
                                                                <li x-text="point"></li>
                                                            </template>
                                                        </ul>
                                                        <h5 class="text-sm font-semibold text-gray-600 mt-3">Sample Answer:</h5>
                                                        <p class="text-sm text-gray-700 mt-1 bg-gray-50 p-3 rounded" x-text="q.answer"></p>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="activeApplication.interview_prep.behavioral_questions && activeApplication.interview_prep.behavioral_questions.length > 0">
                                    <div class="mb-6">
                                        <h4 class="text-lg font-semibold mb-3 text-gray-800 border-b pb-2">Behavioral Questions</h4>
                                        <div class="space-y-3">
                                            <template x-for="(q, index) in activeApplication.interview_prep.behavioral_questions" :key="'behav-' + index">
                                                <div class="border rounded-lg p-4 bg-white">
                                                    <div @click="q.showAnswer = !q.showAnswer" class="flex justify-between items-center cursor-pointer">
                                                        <p class="font-medium text-gray-800" x-text="q.question"></p>
                                                        <span class="text-blue-500" x-text="q.showAnswer ? '−' : '+'" ></span>
                                                    </div>
                                                    <div x-show="q.showAnswer" x-collapse.duration.300ms class="mt-3 pt-3 border-t">
                                                        <h5 class="text-sm font-semibold text-gray-600">Talking Points:</h5>
                                                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1 my-2 pl-2">
                                                            <template x-for="point in q.talking_points" :key="point">
                                                                <li x-text="point"></li>
                                                            </template>
                                                        </ul>
                                                        <h5 class="text-sm font-semibold text-gray-600 mt-3">Sample Answer:</h5>
                                                        <p class="text-sm text-gray-700 mt-1 bg-gray-50 p-3 rounded" x-text="q.answer"></p>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
                <div class="mt-8 pt-6 border-t flex flex-wrap gap-4 justify-end items-center">
                    <button @click="downloadCustomizedResume(activeApplication)" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-semibold">📄 Download Saved Resume</button>
                </div>
             </div>
        </div>


        <div x-show="view === 'nameEntry'" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-40 fade-in">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                <h2 class="text-2xl font-semibold mb-4">Welcome to Resume AI</h2>
                <p class="text-gray-600 mb-6">Let's start with your name to personalize your resume files.</p>
                <div class="space-y-4">
                    <input type="text" x-model="userFirstName" placeholder="First Name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                    <input type="text" x-model="userLastName" placeholder="Last Name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                </div>
                <div class="mt-8 flex justify-end">
                    <button @click="saveUserInfoAndProceed()" :disabled="!userFirstName.trim() || !userLastName.trim()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50">Save and Continue</button>
                </div>
            </div>
        </div>

        <div x-show="view === 'paragraphSelection'" class="fade-in">
            <div class="bg-white rounded-lg shadow-lg p-6 max-w-4xl mx-auto">
                <h2 class="text-2xl font-semibold mb-1">Select Content to Customize</h2>
                <p class="text-gray-600 mb-6 border-b pb-4">Editing: <strong x-text="activeResume.resume_name"></strong></p>
                <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-4">
                    <template x-for="p in paragraphs" :key="p.id">
                        <label class="flex items-start p-3 border rounded-lg cursor-pointer hover:bg-gray-50" :class="selectedParagraphIds.includes(p.id) ? 'border-blue-500 bg-blue-50' : 'border-gray-200'">
                            <input type="checkbox" :value="p.id" x-model="selectedParagraphIds" class="mr-4 mt-1 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 flex-shrink-0">
                            <p class="text-sm text-gray-800" x-text="p.text"></p>
                        </label>
                    </template>
                </div>
                <div class="mt-6 flex justify-between items-center">
                    <button @click="navigateTo('dashboard')" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">Back to Dashboard</button>
                    <button @click="saveSelections()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Save Selections (<span x-text="selectedParagraphIds.length"></span>)</button>
                </div>
            </div>
        </div>

        <div x-show="view === 'customization'" class="fade-in">
            <div class="bg-white rounded-lg shadow-lg p-8 max-w-3xl mx-auto">
                <h2 class="text-2xl font-semibold mb-2">Customize Resume</h2>
                <p class="text-gray-600 mb-6">Using resume: <strong x-text="activeResume.resume_name"></strong></p>
                <div class="space-y-6">
                    <input type="text" x-model="companyName" placeholder="Company Name" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                    <textarea x-model="jobDescription" rows="8" placeholder="Paste the full job description here..." class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500"></textarea>
                    <select x-model="aiModel" class="block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                        <option value="gemini-2.5-pro">Gemini 2.5 Pro (Most Powerful)</option>
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash (Fast & Cost-Effective)</option>
                    </select>
                </div>
                <div class="mt-8 flex justify-between">
                    <button @click="navigateTo('dashboard')" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">Back</button>
                    <button @click="runCustomization()" :disabled="!companyName.trim() || !jobDescription.trim() || isLoading" :class="isLoading ? 'btn-loading bg-green-600' : 'bg-green-600 hover:bg-green-700'" class="text-white px-6 py-2 rounded-lg disabled:opacity-50 font-semibold transition-all duration-200 hover-lift">
                        <span x-show="!isLoading">✨ Customize with AI</span>
                        <span x-show="isLoading" class="opacity-0">✨ Customize with AI</span>
                    </button>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        function resumeApp() {
            return {
                // State
                view: 'dashboard', 
                mainView: 'dashboard', 
                isLoading: false,
                toasts: [],
                isDragging: false,
                showDeleteModal: false,
                itemToDelete: { id: null, type: '' },
                deleteContext: '',
                socket: null,
                userSessionId: null,
                showResumeSelectionModal: false,
                jdToUse: null,
                
                // MODIFIED: Settings Modal State
                showSettingsModal: false,
                activeSettingsTab: 'paragraphs',
                defaultPrompts: {},
                customPrompts: {},
                promptPlaceholders: {
                    paragraphs: ['{COMPANY}', '{JOB_DESCRIPTION}', '{PARAGRAPH_COUNT}', '{SELECTED_PARAGRAPHS_JSON}', '{TOTAL_WORD_LIMIT}'],
                    single_paragraph: ['{COMPANY}', '{JOB_DESCRIPTION}', '{ORIGINAL_PARAGRAPH}', '{WORD_LIMIT}'],
                    cover_letter: ['{COMPANY}', '{JOB_DESCRIPTION}', '{FULL_RESUME_TEXT}'],
                    interview_prep: ['{COMPANY}', '{JOB_TITLE}', '{JOB_DESCRIPTION}', '{FULL_RESUME_TEXT}']
                },
                
                // Job & Result Management
                activeJobs: [], 
                completedJobs: [],
                activeResult: {},
                scrapedJDs: [],

                // User & Data
                userFirstName: '',
                userLastName: '',
                resumes: [],
                applications: [],
                activeApplication: {},
                newResumeName: '',
                fileToUpload: null,
                activeResume: {},
                paragraphs: [],
                selectedParagraphIds: [],
                companyName: '',
                jobDescription: '',
                aiModel: 'gemini-2.5-pro',
                scrapedJdIdToCredit: null,
                
                // --- INITIALIZATION ---
                init() {
                    this.defineDefaultPrompts();
                    this.loadPrompts();
                    this.checkStatus();
                    this.loadUserInfoFromLocalStorage();
                    this.initSocketIO();
                    // Restore UI state after everything is loaded
                    this.$nextTick(() => {
                        this.restoreUIState();
                    });
                },
                async checkStatus() {
                    this.isLoading = true;
                    try {
                        const response = await fetch('/api/status');
                        const data = await response.json();
                        this.userSessionId = data.session_id;
                        if (data.has_set_name) {
                            this.navigateTo('dashboard');
                        } else {
                            this.view = 'nameEntry';
                        }
                    } catch (error) { this.showToast('error', 'Could not connect to server.'); } 
                    finally { this.isLoading = false; }
                },
                loadUserInfoFromLocalStorage() {
                    this.userFirstName = localStorage.getItem('userFirstName') || '';
                    this.userLastName = localStorage.getItem('userLastName') || '';
                    const savedJobs = localStorage.getItem('completedJobs');
                    if (savedJobs) this.completedJobs = JSON.parse(savedJobs);

                    // Restore active jobs from localStorage
                    const savedActiveJobs = localStorage.getItem('activeJobs');
                    if (savedActiveJobs) {
                        this.activeJobs = JSON.parse(savedActiveJobs);
                    }
                },
                initSocketIO() {
                    this.socket = io();
                    this.socket.on('connect', () => {
                        console.log('Socket.IO connected!');
                        // Re-join the user's room after reconnection
                        if (this.userSessionId) {
                            this.socket.emit('join', { session_id: this.userSessionId });
                        }
                    });

                    this.socket.on('session_id', (data) => { this.userSessionId = data.id; });

                    this.socket.on('task_progress', (data) => { this.showToast('info', data.status); });

                    this.socket.on('task_success', async (data) => {
                        console.log('Received task_success:', data.job_id);
                        const job = this.activeJobs.find(j => j.id === data.job_id);
                        console.log('Found matching job:', !!job);

                        if (!job) {
                            console.log('No matching job found in activeJobs, checking if job completed while disconnected');
                            // Job might have completed while we were disconnected
                            // Check if we have a completed job with this ID
                            const existingResult = this.completedJobs.find(r => r.id === data.job_id);
                            if (existingResult) {
                                console.log('Job already completed, ignoring duplicate notification');
                                return;
                            }
                            console.log('Job not found in active or completed jobs - this might be an old notification');
                            return;
                        }

                        const result = data.result;
                        if (result.original_paragraph) {
                            const resultIndex = this.completedJobs.findIndex(r => r.id === job.result_id);
                            if (resultIndex > -1) {
                                const updatedParagraphs = { ...this.completedJobs[resultIndex].customized_paragraphs };
                                updatedParagraphs[result.original_paragraph] = result.enhanced_text;
                                this.completedJobs[resultIndex].customized_paragraphs = updatedParagraphs;
                                if(this.activeResult.id === job.result_id) this.activeResult.customized_paragraphs = updatedParagraphs;
                                this.showToast('success', 'Paragraph regenerated!');
                            }
                        } else if (result.regenerate) {
                             const resultIndex = this.completedJobs.findIndex(r => r.id === job.result_id);
                             if (resultIndex > -1) {
                                 if(result.regenerate === 'paragraphs') {
                                     this.completedJobs[resultIndex].customized_paragraphs = result.customized_paragraphs;
                                     if(this.activeResult.id === job.result_id) this.activeResult.customized_paragraphs = result.customized_paragraphs;
                                     this.showToast('success', 'Paragraphs regenerated!');
                                 } else {
                                     this.completedJobs[resultIndex].cover_letter = result.cover_letter;
                                     if(this.activeResult.id === job.result_id) this.activeResult.cover_letter = result.cover_letter;
                                     this.showToast('success', 'Cover letter regenerated!');
                                 }
                             }
                        } else {
                            const newResult = { id: data.job_id, timestamp: Date.now(), ...job, ...data.result };
                            this.completedJobs.unshift(newResult);
                            this.showToast('success', `AI result for ${job.company_name} is ready!`);
                            // Refresh scraped JDs to get updated status from database
                            if (job.scraped_jd_id) {
                                await this.getScrapedJDs();
                            }
                        }
                        localStorage.setItem('completedJobs', JSON.stringify(this.completedJobs));
                        this.activeJobs = this.activeJobs.filter(j => j.id !== data.job_id);
                        localStorage.setItem('activeJobs', JSON.stringify(this.activeJobs));
                    });

                    this.socket.on('task_error', (data) => {
                        console.log('Received task_error:', data);
                        this.showToast('error', `Task failed: ${data.error}`);
                        if (data.context && data.context.type === 'interview_prep') {
                            this.activeJobs = this.activeJobs.filter(j => !(j.type === 'interview_prep' && j.app_id === data.context.app_id));
                        } else {
                            this.activeJobs = this.activeJobs.filter(j => j.id !== data.job_id);
                        }
                        localStorage.setItem('activeJobs', JSON.stringify(this.activeJobs));
                    });

                    this.socket.on('download_ready', (data) => {
                        this.showToast('success', 'Download ready!');
                        window.location.href = data.download_url;
                    });

                    this.socket.on('interview_prep_ready', (data) => {
                        console.log('Received interview_prep_ready:', data.app_id);
                        this.showToast('success', `Interview prep for application #${data.app_id} is ready!`);
                        this.activeJobs = this.activeJobs.filter(j => !(j.type === 'interview_prep' && j.app_id === data.app_id));
                        localStorage.setItem('activeJobs', JSON.stringify(this.activeJobs));
                        const appIndex = this.applications.findIndex(a => a.id === data.app_id);
                        if (appIndex > -1) this.applications[appIndex].interview_prep = data.interview_prep;
                        if (this.activeApplication && this.activeApplication.id === data.app_id) {
                            this.activeApplication.interview_prep = this.processInterviewPrepData(data.interview_prep);
                        }
                    });

                    // Handle reconnection
                    this.socket.on('reconnect', () => {
                        console.log('Socket.IO reconnected!');
                        if (this.userSessionId) {
                            this.socket.emit('join', { session_id: this.userSessionId });
                        }
                    });

                    this.socket.on('disconnect', () => {
                        console.log('Socket.IO disconnected');
                    });
                },
                async navigateTo(targetView) {
                    this.mainView = targetView;
                    this.view = targetView;
                    if (targetView === 'dashboard') await this.getResumes();
                    if (targetView === 'applications') await this.getApplications();
                    if (targetView === 'scrapedJDs') await this.getScrapedJDs();
                },

                // --- PROMPT MANAGEMENT ---
                defineDefaultPrompts() {
                    this.defaultPrompts = {
                        paragraphs: `You are an expert career coach and professional resume writer. Your task is to transform the provided resume paragraphs to be compelling and tailored for the target role.
CONTEXT:
- COMPANY: {COMPANY}
- TARGET JOB DESCRIPTION:
{JOB_DESCRIPTION}

TASK: TRANSFORM {PARAGRAPH_COUNT} RESUME PARAGRAPHS
- SELECTED PARAGRAPHS (as a JSON object of id:text):
{SELECTED_PARAGRAPHS_JSON}
- GUIDELINES: Inject hard and soft skill keywords from the JD wherever possible. Keep action word repetition low. Restructure sentences for maximum impact and flow. Use strong action verbs, quantify achievements, and align experiences with the target role.
- CRITICAL: Only enhance what's there. Never fabricate new achievements. The total word count for all transformed paragraphs must not exceed {TOTAL_WORD_LIMIT}.`,
                        single_paragraph: `You are an expert career coach and professional resume writer. Your task is to transform the provided resume paragraphs to be compelling and tailored for the target role.
CONTEXT:
- COMPANY: {COMPANY}
- TARGET JOB DESCRIPTION:
{JOB_DESCRIPTION}

TASK: TRANSFORM A SINGLE PARAGRAPH
- ORIGINAL PARAGRAPH: "{ORIGINAL_PARAGRAPH}"
- GUIDELINES: Dramatically improve the paragraph by restructuring sentences for impact, using strong action verbs, quantifying achievements, and integrating keywords from the job description. Maintain a confident, results-oriented tone.
- CRITICAL: Only enhance what's there. Do not fabricate new achievements. The new paragraph must be a similar length, not exceeding {WORD_LIMIT} words.`,
                        cover_letter: `You are an expert career coach. Your task is to write a cover letter and provide a job match score based on the provided context.
CONTEXT:
- COMPANY: {COMPANY}
- TARGET JOB DESCRIPTION:
{JOB_DESCRIPTION}
- FULL RESUME TEXT:
{FULL_RESUME_TEXT}

TASK: WRITE COVER LETTER & PROVIDE MATCH SCORE
- Write a compelling, professional cover letter (3-4 paragraphs, 250-300 words).
- Provide a brutally honest job match score (1-100).
- GUIDELINES: Use a professional tone, show knowledge of the company, and highlight key achievements from the resume. Use plain text only with NO MARKDOWN.
- Match Score (1–100): 90–100 = exceptional; 80–89 = strong; 70–79 = good; below 70 = moderate to weak.`,
                        interview_prep: `You are an expert career coach and interview preparation specialist. Your task is to generate a comprehensive set of interview questions and exemplary answers based on the candidate's resume and the target job description.
CONTEXT:
- COMPANY: {COMPANY}
- TARGET ROLE: {JOB_TITLE}
- TARGET JOB DESCRIPTION:
{JOB_DESCRIPTION}
- CANDIDATE'S FULL RESUME TEXT:
{FULL_RESUME_TEXT}

TASK: GENERATE INTERVIEW QUESTIONS & ANSWERS
Generate two distinct categories of questions. For each question, provide both 'talking_points' (a bulleted list of key ideas to convey) and a complete sample 'answer'.

1.  **General Questions (5 questions):** Tailored to the candidate's specific resume. Scrutinize their career path, skills, and experiences (e.g., job gaps, career changes, specific projects).
2.  **Role-Based Questions (5 questions):** Highly specific to the technical and functional requirements of the job description, framed in the context of the candidate's resume.`
                    };
                },
                loadPrompts() {
                    const saved = localStorage.getItem('customPrompts');
                    this.customPrompts = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(this.defaultPrompts));
                },
                savePrompts() {
                    localStorage.setItem('customPrompts', JSON.stringify(this.customPrompts));
                    this.showToast('success', 'Custom prompts have been saved.');
                    this.showSettingsModal = false;
                },
                resetPrompts() {
                    if(confirm('Are you sure you want to reset all prompts to their default values?')) {
                        this.customPrompts = JSON.parse(JSON.stringify(this.defaultPrompts));
                        this.showToast('info', 'Prompts have been reset to default.');
                        // Force re-render of highlighting after reset
                        this.$nextTick(() => {
                            Object.keys(this.customPrompts).forEach(key => {
                                this.highlightPlaceholders(key);
                            });
                        });
                    }
                },
                handleDrop(event, promptKey) {
                    event.preventDefault();
                    event.stopPropagation();
                    console.log('Drop event fired for:', promptKey);
                    const placeholder = event.dataTransfer.getData('text/plain');
                    console.log('Placeholder data:', placeholder);

                    // Find textarea by data attribute instead of x-ref
                    const textarea = document.querySelector(`[data-textarea-key="${promptKey}"]`);
                    console.log('Textarea found:', !!textarea);

                    if (!textarea || !placeholder) {
                        console.log('Missing textarea or placeholder:', { textarea: !!textarea, placeholder });
                        return;
                    }

                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const currentValue = this.customPrompts[promptKey];
                    console.log('Current value length:', currentValue.length, 'Start:', start, 'End:', end);

                    this.customPrompts[promptKey] = currentValue.substring(0, start) + placeholder + currentValue.substring(end);
                    console.log('New value set, length:', this.customPrompts[promptKey].length);

                    this.$nextTick(() => {
                        textarea.focus();
                        textarea.selectionStart = textarea.selectionEnd = start + placeholder.length;
                        this.highlightPlaceholders(promptKey);
                        console.log('Drop completed for:', promptKey);
                    });
                },
                handleDragOver(event, promptKey) {
                    event.preventDefault();
                    event.stopPropagation();
                    console.log('Drag over event for:', promptKey);
                    const textarea = document.querySelector(`[data-textarea-key="${promptKey}"]`);
                    if (textarea) {
                        textarea.classList.add('drag-over');
                        console.log('Added drag-over class');
                    }
                },
                handleDragLeave(event, promptKey) {
                    event.preventDefault();
                    event.stopPropagation();
                    console.log('Drag leave event for:', promptKey);
                    const textarea = document.querySelector(`[data-textarea-key="${promptKey}"]`);
                    if (textarea) {
                        textarea.classList.remove('drag-over');
                        console.log('Removed drag-over class');
                    }
                },
                handleDragStart(event, placeholder) {
                    console.log('Drag start event for placeholder:', placeholder);
                    event.dataTransfer.setData('text/plain', placeholder);
                    event.dataTransfer.effectAllowed = 'copy';
                    console.log('Data set in drag start:', event.dataTransfer.getData('text/plain'));
                },



                // --- USER INFO ---
                async saveUserInfoAndProceed() {
                    this.isLoading = true;
                    localStorage.setItem('userFirstName', this.userFirstName);
                    localStorage.setItem('userLastName', this.userLastName);
                    try {
                        await fetch('/save_user_info', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ first_name: this.userFirstName, last_name: this.userLastName })
                        });
                        this.showToast('success', 'Information saved!');
                        await this.checkStatus();
                    } catch (error) { this.showToast('error', error.message); } 
                    finally { this.isLoading = false; }
                },
                
                // --- RESUME MANAGEMENT ---
                async getResumes() { try { const r = await fetch('/api/resumes'); this.resumes = await r.json(); } catch (e) { this.showToast('error', 'Could not fetch resumes.'); } },
                handleFileSelect(event) { this.fileToUpload = event.target.files[0]; if (this.newResumeName.trim()) this.uploadNewResume(); },
                handleFileDrop(event) { this.isDragging = false; this.fileToUpload = event.dataTransfer.files[0]; if (this.newResumeName.trim()) this.uploadNewResume(); else this.showToast('error', 'Please provide a resume name first.'); },
                triggerFileUpload() { if (!this.newResumeName.trim()) { this.showToast('error', 'Please provide a resume name first.'); return; } document.getElementById('resumeFileInput').click(); },
                async uploadNewResume() {
                    if (!this.newResumeName.trim() || !this.fileToUpload) return;
                    this.isLoading = true;
                    const formData = new FormData();
                    formData.append('resume_name', this.newResumeName);
                    formData.append('resume_file', this.fileToUpload);
                    formData.append('first_name', this.userFirstName);
                    formData.append('last_name', this.userLastName);
                    try {
                        const response = await fetch('/api/resumes', { method: 'POST', body: formData });
                        const newResume = await response.json();
                        if (!response.ok) throw new Error(newResume.error || 'Upload failed.');
                        this.showToast('success', 'Resume uploaded! Now select paragraphs.');
                        this.newResumeName = ''; this.fileToUpload = null;
                        await this.getResumes();
                        await this.editSelections(newResume.id);
                    } catch (error) { this.showToast('error', error.message); } 
                    finally { this.isLoading = false; }
                },
                confirmDelete(id, type) { this.itemToDelete = { id, type }; this.deleteContext = type; this.showDeleteModal = true; },
                async deleteItem() {
                    this.isLoading = true;
                    this.showDeleteModal = false;
                    const { id, type } = this.itemToDelete;
                    let endpoint = (type === 'resume') ? `/api/resumes/${id}` : (type === 'application') ? `/api/applications/${id}` : (type === 'scraped_jd') ? `/api/scraped-jds/${id}` : '';
                    if (!endpoint) return;

                    try {
                        const response = await fetch(endpoint, { method: 'DELETE' });
                        if (!response.ok) throw new Error(`Failed to delete ${type}.`);
                        this.showToast('success', `${type.replace('_', ' ')} deleted.`);
                        if (type === 'resume') this.resumes = this.resumes.filter(r => r.id !== id);
                        if (type === 'application') this.applications = this.applications.filter(a => a.id !== id);
                        if (type === 'scraped_jd') this.scrapedJDs = this.scrapedJDs.filter(j => j.id !== id);
                    } catch (error) { this.showToast('error', error.message); } 
                    finally { this.isLoading = false; }
                },

                // --- SCRAPED JD MANAGEMENT ---
                async getScrapedJDs() { try { const r = await fetch('/api/scraped-jds'); this.scrapedJDs = await r.json(); } catch (e) { this.showToast('error', 'Could not fetch scraped JDs.'); } },
                async deleteScrapedJD(jdId, showToast = true) {
                     try {
                        await fetch(`/api/scraped-jds/${jdId}`, { method: 'DELETE' });
                        if (showToast) this.showToast('success', `Scraped JD deleted.`);
                        this.scrapedJDs = this.scrapedJDs.filter(j => j.id !== jdId);
                    } catch (error) { if (showToast) this.showToast('error', 'Failed to delete scraped JD'); }
                },
                useScrapedJD(jd) {
                    if (this.resumes.length === 0) { this.showToast('error', 'You must upload at least one resume first.'); return; }
                    if (this.resumes.length === 1) {
                        this.startCustomizationWithSelectedResume(this.resumes[0], jd);
                    } else {
                        this.jdToUse = jd;
                        this.showResumeSelectionModal = true;
                    }
                },
                startCustomizationWithSelectedResume(resume, jd = null) {
                    const jobData = jd || this.jdToUse;
                    this.showToast('info', `Using resume: ${resume.resume_name}`);
                    this.activeResume = resume;
                    this.companyName = jobData.company_name;
                    this.jobDescription = jobData.job_description;
                    this.scrapedJdIdToCredit = jobData.id;
                    this.showResumeSelectionModal = false;
                    this.jdToUse = null;
                    this.view = 'customization';
                },

                // --- PARAGRAPH SELECTION ---
                async editSelections(resumeId) {
                    this.isLoading = true;
                    try {
                        const response = await fetch(`/api/resumes/${resumeId}`);
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error || 'Could not load resume details.');
                        this.activeResume = data;
                        this.paragraphs = data.paragraphs || [];
                        this.selectedParagraphIds = data.selected_paragraph_ids || [];
                        this.view = 'paragraphSelection';
                    } catch (error) { this.showToast('error', error.message); this.view = 'dashboard'; } 
                    finally { this.isLoading = false; }
                },
                async saveSelections() {
                    this.isLoading = true;
                    try {
                        await fetch(`/api/resumes/${this.activeResume.id}/selections`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ selected_paragraph_ids: this.selectedParagraphIds })
                        });
                        this.showToast('success', 'Selections saved.');
                        this.navigateTo('dashboard');
                    } catch (error) { this.showToast('error', 'Failed to save selections.'); } 
                    finally { this.isLoading = false; }
                },

                // --- CUSTOMIZATION & RESULTS ---
                startCustomization(resume) { this.activeResume = resume; this.companyName = ''; this.jobDescription = ''; this.scrapedJdIdToCredit = null; this.view = 'customization'; },
                async runCustomization(options = {}) {
                    this.isLoading = true;
                    let payload;
                    try {
                        if(options.regenerate) {
                            const result = this.completedJobs.find(r => r.id === options.result_id);
                            if(!result) throw new Error('Could not find original result for regeneration.');
                             payload = { resume_id: result.resume_id, company_name: result.company_name, job_description: result.job_description, ai_model: this.aiModel, regenerate: options.regenerate, result_id: options.result_id, custom_prompts: this.customPrompts };
                        } else {
                            payload = { resume_id: this.activeResume.id, company_name: this.companyName, job_description: this.jobDescription, ai_model: this.aiModel, scraped_jd_id: this.scrapedJdIdToCredit, custom_prompts: this.customPrompts };
                        }
                        const response = await fetch('/customize', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error || 'AI customization failed.');

                        // Create job object with all necessary data
                        const jobData = {
                            id: data.job_id,
                            resume_id: payload.resume_id,
                            company_name: payload.company_name,
                            job_description: payload.job_description,
                            ai_model: payload.ai_model,
                            custom_prompts: payload.custom_prompts,
                            scraped_jd_id: payload.scraped_jd_id,
                            type: 'customization',
                            timestamp: Date.now()
                        };

                        // Add to active jobs
                        this.activeJobs.unshift(jobData);
                        console.log('Added job to active jobs:', jobData);
                        console.log('Active jobs count:', this.activeJobs.length);

                        // Save to localStorage immediately
                        localStorage.setItem('activeJobs', JSON.stringify(this.activeJobs));

                        this.showToast('info', `Started AI job for ${payload.company_name}...`);
                        if(!options.regenerate) this.navigateTo('resultsHub');
                        this.scrapedJdIdToCredit = null;

                        // Start polling immediately
                        this.startJobPolling();

                    } catch (error) {
                        console.error('Error starting customization:', error);
                        this.showToast('error', error.message);
                    }
                    finally { this.isLoading = false; }
                },
                viewResults(jobId) {
                    const result = this.completedJobs.find(j => j.id === jobId);
                    if (result) { this.activeResult = { ...result }; this.view = 'results'; }
                },
                 deleteResult(jobId) {
                    this.completedJobs = this.completedJobs.filter(j => j.id !== jobId);
                    localStorage.setItem('completedJobs', JSON.stringify(this.completedJobs));
                    this.showToast('success', 'Result discarded.');
                },
                async saveCurrentApplication() {
                    this.isLoading = true;
                    try {
                        const payload = {
                            resume_id: this.activeResult.resume_id,
                            company_name: this.activeResult.company_name,
                            job_description: this.activeResult.job_description,
                            cover_letter: this.activeResult.cover_letter,
                            match_score: this.activeResult.match_score,
                            match_score_analysis: this.activeResult.match_score_analysis,  // New field
                            customized_paragraphs: this.activeResult.customized_paragraphs
                        };

                        // Add job posting URL if this came from a scraped job
                        if (this.activeResult.scraped_jd_id) {
                            console.log('DEBUG: Saving application with scraped_jd_id:', this.activeResult.scraped_jd_id);
                            console.log('DEBUG: Available scraped JDs:', this.scrapedJDs.map(jd => ({ id: jd.id, url: jd.page_url })));

                            const scrapedJob = this.scrapedJDs.find(jd => jd.id === this.activeResult.scraped_jd_id);
                            console.log('DEBUG: Found scraped job:', scrapedJob);

                            if (scrapedJob && scrapedJob.page_url) {
                                payload.job_posting_url = scrapedJob.page_url;
                                console.log('DEBUG: Adding job posting URL:', scrapedJob.page_url);
                            } else {
                                console.log('DEBUG: No URL found for scraped job');
                            }
                        } else {
                            console.log('DEBUG: No scraped_jd_id found in activeResult');
                        }

                        console.log('DEBUG: Final payload:', payload);

                        const response = await fetch('/api/applications', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                        if (!response.ok) throw new Error('Failed to save application.');
                        this.showToast('success', 'Application saved!');
                        this.deleteResult(this.activeResult.id);
                        this.navigateTo('applications');
                    } catch (error) { this.showToast('error', error.message); }
                    finally { this.isLoading = false; }
                },
                async downloadCustomizedResume(source) {
                    this.showToast('info', 'Your download is being prepared...');
                    try {
                        const payload = { resume_id: source.resume_id, customizations: { customized_paragraphs: source.customized_paragraphs }, company_name: source.company_name };
                        await fetch('/api/download_resume', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    } catch (error) { this.showToast('error', 'Failed to queue download.'); }
                },
                
                // --- APPLICATION MANAGEMENT ---
                async getApplications() { try { const r = await fetch('/api/applications'); this.applications = await r.json(); } catch (e) { this.showToast('error', 'Could not fetch applications.'); } },
                processInterviewPrepData(prepData) {
                    if (!prepData) return null;
                    const addShowAnswer = (q) => ({...q, showAnswer: false});
                    if (prepData.general_questions) prepData.general_questions = prepData.general_questions.map(addShowAnswer);
                    if (prepData.role_based_questions) prepData.role_based_questions = prepData.role_based_questions.map(addShowAnswer);
                    if (prepData.behavioral_questions) prepData.behavioral_questions = prepData.behavioral_questions.map(addShowAnswer);
                    return prepData;
                },
                async viewApplicationDetails(appId) {
                    this.isLoading = true;
                    try {
                        const response = await fetch(`/api/applications/${appId}`);
                        const data = await response.json();
                        if (!response.ok) throw new Error('Could not fetch application details.');
                        if (!this.resumes.length) await this.getResumes();
                        const resume = this.resumes.find(r => r.id === data.resume_id);
                        data.resume_name = resume ? resume.resume_name : 'Unknown';
                        data.interview_prep = this.processInterviewPrepData(data.interview_prep);
                        this.activeApplication = data;
                        this.view = 'applicationDetail';
                    } catch (error) { this.showToast('error', error.message); } 
                    finally { this.isLoading = false; }
                },
                async updateApplication(appId, payload) {
                    try {
                        await fetch(`/api/applications/${appId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        this.showToast('success', 'Application updated.');
                    } catch (error) { this.showToast('error', 'Could not update application.'); }
                },
                
                // --- INTERVIEW PREP ---
                async generateInterviewPrep(appId) {
                    this.showToast('info', 'Starting interview prep generation...');
                    this.activeJobs.push({ id: `interview-${appId}`, type: 'interview_prep', app_id: appId });
                    try {
                        const payload = { ai_model: this.aiModel, custom_prompts: this.customPrompts };
                        await fetch(`/api/applications/${appId}/generate-interview-prep`, { 
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'}, 
                            body: JSON.stringify(payload) 
                        });
                    } catch (error) {
                        this.showToast('error', 'Failed to start generation job.');
                        this.activeJobs = this.activeJobs.filter(j => j.id !== `interview-${appId}`);
                    }
                },
                async copyInterviewPrompt(appId) {
                    try {
                        // MODIFIED: Send custom prompt to get correctly formatted prompt text
                        const response = await fetch(`/api/applications/${appId}/interview-prompt-text`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ custom_prompt: this.customPrompts.interview_prep })
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error || 'Failed to get prompt text.');
                        this.copyToClipboard(data.prompt_text);
                    } catch(e) { this.showToast('error', e.message); }
                },
                isJobActive(type, id) {
                    if (type === 'interview_prep') {
                        return this.activeJobs.some(j => j.type === 'interview_prep' && j.app_id === id);
                    }
                    return false;
                },

                // --- UI STATE RESTORATION ---
                restoreUIState() {
                    console.log('Restoring UI state...');
                    console.log('Active jobs:', this.activeJobs.length);
                    console.log('Completed jobs:', this.completedJobs.length);

                    // If we have active jobs, make sure we're showing the progress
                    if (this.activeJobs.length > 0) {
                        console.log('Found active jobs, showing progress indicators');

                        // If we're on the dashboard but have active jobs, navigate to results hub
                        if (this.mainView === 'dashboard' && this.activeJobs.some(j => j.type !== 'interview_prep')) {
                            console.log('Navigating to results hub to show active jobs');
                            this.navigateTo('resultsHub');
                        }

                        // If we have interview prep jobs, make sure the application detail view shows progress
                        const interviewJobs = this.activeJobs.filter(j => j.type === 'interview_prep');
                        if (interviewJobs.length > 0) {
                            console.log('Found interview prep jobs, checking if we need to show progress');
                            // The progress should show automatically due to reactive binding
                        }

                        // Start polling for job completion as a fallback
                        this.startJobPolling();
                    }

                    // If we have completed jobs but no active jobs, make sure results are visible
                    if (this.completedJobs.length > 0 && this.activeJobs.length === 0) {
                        console.log('Found completed jobs, ensuring results are accessible');
                        // Results should be visible in the results hub
                    }

                    console.log('UI state restoration complete');
                },

                // --- JOB POLLING FALLBACK ---
                startJobPolling() {
                    console.log('Starting job polling as fallback mechanism');
                    if (this.jobPollingInterval) {
                        clearInterval(this.jobPollingInterval);
                    }

                    this.jobPollingInterval = setInterval(async () => {
                        await this.checkActiveJobs();
                    }, 3000); // Check every 3 seconds
                },

                stopJobPolling() {
                    console.log('Stopping job polling');
                    if (this.jobPollingInterval) {
                        clearInterval(this.jobPollingInterval);
                        this.jobPollingInterval = null;
                    }
                },

                async checkActiveJobs() {
                    if (this.activeJobs.length === 0) {
                        this.stopJobPolling();
                        return;
                    }

                    console.log('Polling for job completion...');

                    for (const job of this.activeJobs) {
                        try {
                            const response = await fetch(`/api/job-status/${job.id}`);
                            const data = await response.json();

                            if (data.status === 'completed') {
                                console.log('Job completed via polling:', job.id);
                                await this.handleJobCompletion(job, data.result);
                            } else if (data.status === 'failed') {
                                console.log('Job failed via polling:', job.id);
                                this.showToast('error', `Job failed: ${data.error}`);
                                this.activeJobs = this.activeJobs.filter(j => j.id !== job.id);
                                localStorage.setItem('activeJobs', JSON.stringify(this.activeJobs));
                            }
                        } catch (error) {
                            console.error('Error polling job status:', error);
                        }
                    }
                },

                async handleJobCompletion(job, result) {
                    console.log('Handling job completion for:', job.id);

                    // Remove from active jobs
                    this.activeJobs = this.activeJobs.filter(j => j.id !== job.id);
                    localStorage.setItem('activeJobs', JSON.stringify(this.activeJobs));

                    // Add to completed jobs
                    const newResult = { id: job.id, timestamp: Date.now(), ...job, ...result };
                    this.completedJobs.unshift(newResult);
                    localStorage.setItem('completedJobs', JSON.stringify(this.completedJobs));

                    // Show success message
                    this.showToast('success', `AI result for ${job.company_name} is ready!`);

                    // Refresh scraped JDs to get updated status from database
                    if (job.scraped_jd_id) {
                        await this.getScrapedJDs();
                    }

                    // Stop polling if no more active jobs
                    if (this.activeJobs.length === 0) {
                        this.stopJobPolling();
                    }
                },

                // --- UTILITIES ---
                showToast(type, message, duration = 5000) {
                    const id = Date.now();
                    this.toasts.push({ id, type, message });
                    setTimeout(() => { this.toasts = this.toasts.filter(t => t.id !== id); }, duration);
                },
                copyToClipboard(text) {
                    if (!text) return;
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    ta.style.position = 'fixed'; ta.style.opacity = 0;
                    document.body.appendChild(ta);
                    ta.select();
                    try { document.execCommand('copy'); this.showToast('success', 'Copied to clipboard!'); } 
                    catch (err) { this.showToast('error', 'Failed to copy.'); }
                    document.body.removeChild(ta);
                }
            }
        }
    </script>
</body>
</html>
